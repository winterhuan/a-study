# 状态管理机制

## Checkpoint vs Changelog vs Savepoint

基于代码中的上下文，这里对比 Flink 中三种不同的状态管理机制：

### 1. Checkpoint（检查点）

**目的**：**故障恢复机制**

- 自动定期创建作业状态快照
- 当作业失败时，从最新检查点恢复状态
- 确保 Exactly-Once 语义

**特性**：

```java
// 启用检查点
env.enableCheckpointing(1000); // 每秒创建一个检查点
```

- **自动触发**：按固定时间间隔自动执行
- **轻量级**：检查点元数据保存在 JobManager 内存中
- **快速恢复**：从检查点快速重启作业
- **临时性**：主要用于故障恢复，完成使命后可被清理

### 2. Changelog（变更日志）

**目的**：**优化检查点机制**

- 通过细粒度状态变更记录优化检查点性能
- 解决大状态作业的检查点瓶颈问题

**特性**：

```java
// 启用变更日志
env.enableChangelogStateBackend(true);
```

- **增量记录**：只记录状态变更而非完整状态
- **快速确认**：算子可在变更日志持久化后立即确认检查点
- **异步物化**：状态表定期独立于检查点进行持久化
- **存储优化**：大幅减少检查点存储开销和时间

### 3. Savepoint（保存点）

**目的**：**手动状态管理**

- 人工触发的持久化状态快照
- 用于作业升级、迁移和暂停/恢复

**特性**：

```java
// 设置默认保存点目录
env.setDefaultSavepointDirectory("hdfs://namenode:9000/savepoints/");

// 触发保存点（需在运行时调用）
env.triggerSavepoint(savepointPath);
```

- **手动触发**：由用户显式触发
- **长期保存**：设计为长期保存，可跨版本使用
- **版本管理**：支持作业升级和回滚
- **可移植性**：可在不同集群和配置间迁移

### 三者对比表

| 特性 | Checkpoint | Changelog | Savepoint |
|------|------------|-----------|-----------|
| **触发方式** | 自动（定时） | 自动（与检查点结合） | 手动触发 |
| **主要用途** | 故障恢复 | 性能优化 | 版本管理/迁移 |
| **持久化** | 临时 | 临时 | 长期保存 |
| **粒度** | 完整状态 | 状态变更 | 完整状态 |
| **性能开销** | 中等 | 低 | 高 |
| **恢复速度** | 快 | 中等 | 中等 |
| **跨版本支持** | ❌ | ❌ | ✅ |

### 相互关系

**协同工作**：

```text
Checkpoint（故障恢复）
    ├── 使用 Changelog（优化性能）
    └── 与 Savepoint（版本管理）互补
```

**典型使用场景**：

- **生产环境**：启用检查点 + 可选变更日志
- **作业升级**：先触发保存点 → 停止作业 → 升级 → 从保存点恢复
- **大状态作业**：启用变更日志优化检查点性能

### 代码示例

```java
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();

// 基础检查点配置
env.enableCheckpointing(5000); // 5秒检查点间隔

// 针对大状态作业启用变更日志优化
env.enableChangelogStateBackend(true);

// 设置保存点目录（用于手动备份）
env.setDefaultSavepointDirectory("hdfs://namenode:9000/flink-savepoints/");

DataStream<String> stream = // ... 数据源定义
// ... 业务逻辑

// 执行作业
env.execute("My Streaming Job");
```

这种多层次的状态管理机制让 Flink 既能保证数据一致性，又能提供灵活的状态管理能力。
